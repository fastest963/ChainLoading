(function(s){function h(a,b){this.chain=a;this.active=b||!1;this.completed=!0;this.state="";this.dfds=[];this.failCallbacks=[];this.nextLevel=null}function t(a,b,e,d,m){function n(){for(var a=0;a<c.length&&0!==c[a].s;a++)null!==c[a].args&&g.args.push.apply(g.args,c[a].args),c.splice(a,1),a--;0===c.length&&e("resolved",g)}this.args=[];this.promise=new k(a);var g=this,h=this.promise,c=[],l;a=0;for(l=b.length;a<l;a++){if(b[a]===p)throw Error("Undefined sent to sent. Did you mean to return deferred?");
c.push({d:b[a],s:0,args:null})}a=0;for(l=c.length;a<l;a++)if("function"===typeof c[a].d)c[a].s=1,this.promise.done(c[a].d);else{if("function"!==typeof c[a].d.done)throw Error("Invalid deferred sent to chain");(function(a){a.d.done(function(){a.args=f.call(arguments);a.s=1;var b=this;h.done(function(){m.set(b);for(var a=0;a<d.length;a++)b===d[a].d&&(h.done(d[a].func),d.splice(a,1),a--)});n()});a.d.fail(function(){g.args=f.call(arguments);var a=this;h.fail(function(){m.set(a);for(var b=0;b<d.length;b++)a===
d[b].d&&(h.fail(d[b].func),d.splice(b,1),b--)});e("rejected",g)})})(c[a])}0<c.length&&n()}function k(a){this.ctx=a;this.args=this.s=null;this.callbacks=[]}function q(){function a(){for(var a=0;a<k.length;a++)k[a].call(d),k.splice(a,1),a--}function b(b,e){var g=c!==p,f;if(!g||"rejected"!==c.state)return f=new h(d,!g||c.completed),f.addFailCallback(a),g&&(c.nextLevel=f),c=f,f[b](e,m,n)}function e(b,d){c===p&&(c=new h(this,!0),c.addFailCallback(a));return c[b](d,m,n)}var d=this,m=[],n=new r,g=[],k=[],
c;this.push=this.next=function(){return b("requireDeferreds",f.call(arguments))};this.add=function(){return e("requireDeferreds",f.call(arguments))};this.pushIgnoreFail=this.nextIgnoreFail=function(){return b("optionalDeferreds",f.call(arguments))};this.addIgnoreFail=function(){return e("optionalDeferreds",f.call(arguments))};this.done=this.after=function(a,b){b?this.add(a):this.push(a);return this};this.fail=function(a){c===p?k.push(a):c.addFailCallback(a);return this};var l=function(a,b,c){return function(){var e;
e=c===p?function(){a.apply(b,f.call(arguments))}:function(){a.apply(b,c.concat(f.call(arguments)));c.length=0};this===d||n.has(this)?e():m.push({d:this,func:e,s:this.state()})}};this.bind=function(a,b){return 3>arguments.length?l(a,b):l(a,b,f.call(arguments,2))};this.applyArgs=function(a,b){if(3>arguments.length)return l(a,b,g);var c=f.call(arguments,2);return function(){var d=g.concat(c).concat(f.call(arguments));g.length=0;l(a,b,d).call(this)}};this.storeArgs=function(){var a=f.call(arguments),
b=function(){g.push.apply(g,a)};if(this===d)return b;n.has(this)?b():m.push({d:this,func:b,s:this.state()})};this.always=function(a){return this.fail(a).done(a)};this.fork=function(){var a=new q;a.push(this);return a}}var r=s.WeakMap,f=[].slice,p;r===p&&(r=function(){var a=[];this.has=function(b){var e=-1;for(null!=b&&(e=a.length-1);0<=e&&a[e]!==b;)e--;return-1<e};this.set=function(b){a.push(b)}});h.prototype.newGroup=function(a,b,e,d){""===this.state&&(this.completed=!1);var f={s:0,r:this.active};
this.dfds.push(f);return new t(this.chain,a,function(a,d){f.g=d;f.s=1;b(a,f.r)},e,d)};h.prototype.requireDeferreds=function(a,b,e){var d=this;return this.newGroup(a,function(a,b){switch(a){case "resolved":""===d.state&&(d.state="resolved");break;case "rejected":d.state="rejected"}b&&d.complete()},b,e).promise};h.prototype.optionalDeferreds=function(a,b,e){var d=this;return this.newGroup(a,function(a,b){switch(a){case "resolved":""===d.state&&(d.state="resolved");break;case "rejected":d.state="ignored"}b&&
d.complete()},b,e).promise};h.prototype.addFailCallback=function(a){"ignored"===this.state||"rejected"===this.state?a.call(this.chain):this.completed&&""!==this.state||this.failCallbacks.push(a)};h.prototype.complete=function(){this.active=!0;for(var a=0;a<this.dfds.length;a++){if("function"===typeof this.dfds[a])this.dfds[a]();else{this.dfds[a].r=!0;if(0===this.dfds[a].s)break;this.dfds[a].g.complete(this.state)}this.dfds.splice(a,1);a--}0===this.dfds.length&&(this.completed=!0);!0===this.completed&&
("rejected"===this.state?this.failed():(this.cleanup(!0),null!==this.nextLevel&&this.nextLevel.complete()))};h.prototype.failed=function(){for(var a=0;a<this.failCallbacks.length;a++)this.failCallbacks[a].call(this.chain),this.failCallbacks.splice(a,1),a--;this.cleanup(!0);null!==this.nextLevel&&this.nextLevel.failed()};h.prototype.cleanup=function(a){var b,e;for(b=0;b<this.dfds.length;b++)this.dfds[b].r=!1,this.dfds.splice(b,1),b--;b=0;for(e=this.failCallbacks.length;b<e;b++)this.failCallbacks.shift();
null!==this.nextLevel&&!0!==a&&this.nextLevel.cleanup()};t.prototype.complete=function(a){var b=this.promise.callbacks;null===this.promise.s&&(this.promise.s="ignored"===a?"rejected":a,this.promise.args=this.args);for(a=0;a<b.length;a++)b[a].s===this.promise.s&&b[a].f.apply(this.promise.ctx,this.promise.args),b.splice(a,1),a--};k.prototype.done=function(){var a,b;if("resolved"===this.s)for(a=0,b=arguments.length;a<b;a++)arguments[a].apply(this.ctx,this.args);else if(null===this.s)for(a=0,b=arguments.length;a<
b;a++){if("function"!==typeof arguments[a])throw Error("Invalid function sent to done "+typeof arguments[a]);this.callbacks.push({s:"resolved",f:arguments[a]})}return this};k.prototype.fail=function(){var a,b;if("rejected"===this.s)for(a=0,b=arguments.length;a<b;a++)arguments[a].apply(this.ctx,this.args);else if(null===this.s)for(a=0,b=arguments.length;a<b;a++){if("function"!==typeof arguments[a])throw Error("Invalid function sent to fail "+typeof arguments[a]);this.callbacks.push({s:"rejected",f:arguments[a]})}return this};
k.prototype.state=function(){return this.s};"undefined"!==typeof module?module.exports=q:(s.ChainLoading=q,"function"==typeof define&&"object"==typeof define.amd&&define.amd&&define("ChainLoading",function(){return q}))})(this);
