(function(w){function k(a,b){this.chain=a;this.ready=b||!1;this.completed=!0;this.state="";this.dfds=[];this.failCallbacks=[];this.prevLevel=this.nextLevel=null}function x(a,b,c,k){function q(a){e||(e=!0,d.length=0,b(a,p))}function r(){for(var a=0;a<d.length&&l&&!e&&0!==d[a].s;a++)null!==d[a].args&&p.args.push.apply(p.args,d[a].args),d.splice(a,1),a--;0===d.length&&q("resolved")}this.args=[];this.promise=new m;var p=this,n=this.promise,d=[],e=!1,l=!1,h,t;h=0;for(t=a.length;h<t;h++){if(a[h]===g)throw Error("Undefined sent to push/add. Did you forget to return a deferred?");
d.push({d:a[h],s:0,args:null})}h=0;for(t=d.length;h<t&&!e;h++)if("function"===typeof d[h].d)d[h].s=1,this.promise.done(d[h].d);else{if("function"!==typeof d[h].d.then)throw Error("Invalid deferred sent to chain");(function(a){a.d.then(function(){if(0===a.s){a.args=f.call(arguments);a.s=1;var b=this;n.done(function(){k.set(b);for(var a=0;a<c.length;a++)b===c[a].d&&(n.done(c[a].func),c.splice(a,1),a--)});r()}},function(){if(0===a.s){p.args=f.call(arguments);a.s=1;var b=this;n.fail(function(){k.set(b);
for(var a=0;a<c.length;a++)b===c[a].d&&(n.fail(c[a].func),c.splice(a,1),a--)});q("rejected")}})})(d[h])}l=!0;r()}function m(a){this.ctx=a||this;this.s="pending";this.args=null;this.callbacks=[]}function u(){}function l(){function a(){if(n!==g)for(var a=0;a<n.length;a++)n[a].call(q),n.splice(a,1),a--}function b(){var b=e!==g,c=new k(q,!b||e.completed);n!==g&&c.addFailCallback(a);b&&(e.nextLevel=c,c.prevLevel=e,e.removeFailCallback(a));return e=c}function c(a,c){if(e!==g&&"rejected"===e.normalizedState())return new u;
b();return e[a](c,r,p)}function l(a,c){if(e===g)b();else if("rejected"===e.normalizedState())return new u;return e[a](c,r,p)}var q=this,r=[],p=new v,n,d,e,s;this.push=this.next=function(){return c("requireDeferreds",f.call(arguments))};this.add=function(){return l("requireDeferreds",f.call(arguments))};this.pushIgnoreFail=this.nextIgnoreFail=function(){return c("optionalDeferreds",f.call(arguments))};this.addIgnoreFail=function(){return l("optionalDeferreds",f.call(arguments))};this.stop=function(){var a=
e;if(a===g)a=b();else for(;null!==a.prevLevel&&(a=a.prevLevel););a.stop();return this};this.fail=this["catch"]=function(a){e===g?(n===g&&(n=[]),n.push(a)):e.addFailCallback(a);return this};var h=function(a,b,c){return function(){var d;d=c===g?function(){a.apply(b,f.call(arguments))}:function(){a.apply(b,c.concat(f.call(arguments)));c.length=0};this===q||this instanceof m||p.has(this)?d.apply(this,f.call(arguments)):r.push({d:this,func:d,s:this.state()})}};this.bind=function(a,b){return 3>arguments.length?
h(a,b):h(a,b,f.call(arguments,2))};this.applyArgs=function(a,b){if(3>arguments.length)return d===g&&(d=[]),h(a,b,d);var c=f.call(arguments,2);return function(){var e=(d||[]).splice(0,d.length).concat(c).concat(f.call(arguments));h(a,b,e).call(this)}};this.storeArgs=function(){var a=f.call(arguments),b=function(){d===g&&(d=[]);d.push.apply(d,a)};if(this===q)return b;this instanceof m||p.has(this)?b():r.push({d:this,func:b,s:this.state()})};this.state=function(){return e===g?"pending":e.normalizedState()};
this.promise=function(){if(s===g){var a=function(a,b){return function(c,d,e){return a.call(b,c,d,e)}};s={state:this.state,done:a(this.done,this),fail:a(this.fail,this),always:a(this.always,this),then:a(this.then,this)}}return s}}var v=w.WeakMap,f=[].slice,y=function(){return this},g;v===g&&(v=function(){var a=[];this.has=function(b){var c=-1;for(null!=b&&(c=a.length-1);0<=c&&a[c]!==b;)c--;return-1<c};this.set=function(b){a.push(b)}});k.prototype.newGroup=function(a,b,c,k){""===this.state&&(this.completed=
!1);var g={s:0,r:this.ready},f=this;this.dfds.push(g);return new x(a,function(a,c){g.g=c;g.s=1;switch(a){case "resolved":""===f.state&&(f.state="resolved");break;case "rejected":"stopped"!==f.state&&(f.state=b)}f.complete()},c,k)};k.prototype.requireDeferreds=function(a,b,c){return this.newGroup(a,"rejected",b,c).promise};k.prototype.optionalDeferreds=function(a,b,c){return this.newGroup(a,"ignored",b,c).promise};k.prototype.addFailCallback=function(a){"ignored"===this.state||"rejected"===this.state?
a.call(this.chain):this.completed&&""!==this.state||this.failCallbacks.push(a)};k.prototype.removeFailCallback=function(a){a=this.failCallbacks.indexOf(a);-1!==a&&this.failCallbacks.splice(a,1)};k.prototype.complete=function(){if(!0===this.ready){var a="ignored"===this.state?"rejected":this.normalizedState(),b;for(b=0;b<this.dfds.length;b++){if("function"===typeof this.dfds[b])this.dfds[b]();else{this.dfds[b].r=!0;if(0===this.dfds[b].s)break;this.dfds[b].g.complete(a)}this.dfds.splice(b,1);b--}0===
this.dfds.length&&("rejected"===this.state?this.completeFailed():(this.cleanup(),"stopped"!==this.state&&(null!==this.nextLevel&&(this.nextLevel.ready=!0,this.nextLevel.complete()),this.cleanupLevelRefs())))}};k.prototype.completeFailed=function(){for(var a=0;a<this.failCallbacks.length;a++)this.failCallbacks[a].call(this.chain),this.failCallbacks.splice(a,1),a--;this.cleanup();null!==this.nextLevel&&this.nextLevel.completeFailed();this.cleanupLevelRefs()};k.prototype.cleanup=function(a){var b;for(a=
0;a<this.dfds.length;a++)this.dfds[a].r=!1,this.dfds.splice(a,1),a--;this.completed=!0;a=0;for(b=this.failCallbacks.length;a<b;a++)this.failCallbacks.shift()};k.prototype.cleanupLevelRefs=function(){this.prevLevel=this.nextLevel=null};k.prototype.normalizedState=function(){return"stopped"===this.state?"rejected":"ignored"===this.state?"resolved":this.state||"pending"};k.prototype.stop=function(a){this.ready=!1;this.state="stopped";this.cleanup();null!==this.nextLevel&&this.nextLevel.stop();this.cleanupLevelRefs()};
x.prototype.complete=function(a){var b=this.promise.callbacks;"pending"===this.promise.s&&(this.promise.s=a,this.promise.args=this.args);for(a=0;a<b.length;a++)b[a].s===this.promise.s&&b[a].f.apply(this.promise.ctx,this.promise.args),b.splice(a,1),a--};m.prototype.done=function(){var a,b;if("resolved"===this.s)for(a=0,b=arguments.length;a<b;a++)arguments[a].apply(this.ctx,this.args);else if("pending"===this.s)for(a=0,b=arguments.length;a<b;a++){if("function"!==typeof arguments[a])throw Error("Invalid function sent to done "+
typeof arguments[a]);this.callbacks.push({s:"resolved",f:arguments[a]})}return this};m.prototype.then=function(a,b){"function"===typeof a?this.done(a):null!=a&&this.done.apply(this,a);"function"===typeof b?this.fail(b):null!=b&&this.fail.apply(this,b);return this};m.prototype.fail=function(){var a,b;if("rejected"===this.s)for(a=0,b=arguments.length;a<b;a++)arguments[a].apply(this.ctx,this.args);else if("pending"===this.s)for(a=0,b=arguments.length;a<b;a++){if("function"!==typeof arguments[a])throw Error("Invalid function sent to fail "+
typeof arguments[a]);this.callbacks.push({s:"rejected",f:arguments[a]})}return this};m.prototype["catch"]=m.prototype.fail;m.prototype.always=function(){var a=f.call(arguments);return this.fail.apply(this,a).done.apply(this,a)};m.prototype.state=function(){return this.s};for(var s in m.prototype)m.prototype.hasOwnProperty(s)&&"function"===typeof m.prototype[s]&&(u.prototype[s]=y);u.prototype.state=function(){return"pending"};l.prototype.done=l.prototype.after=function(a,b){b?this.add(a):this.push(a);
return this};l.prototype.then=function(a,b){var c,f;if("function"===typeof a)this.done(a);else if(null!=a)for(c=0,f=a.length;c<f;c++)this.done(a[c]);if("function"===typeof b)this.fail(b);else if(null!=b)for(c=0,f=b.length;c<f;c++)this.fail(b[c]);return this};l.prototype.always=function(a){if(1===arguments.length)return this.fail(a).done(a);var b=f.call(arguments);return this.fail.apply(this,b).done.apply(this,b)};l.prototype.fork=function(){var a=new l;a.push(this);return a};"undefined"!==typeof module?
module.exports=l:(w.ChainLoading=l,"function"===typeof define&&"object"===typeof define.amd&&define.amd&&define("ChainLoading",function(){return l}))})(this);
