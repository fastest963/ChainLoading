(function(x){function h(a,b){this.chain=a;this.ready=b||!1;this.completed=!0;this.state="";this.dfds=[];this.failCallbacks=[];this.prevLevel=this.nextLevel=null}function y(a,b,c,e,p){function h(a){q||(q=!0,d.length=0,c(a,n))}function f(){for(var a=0;a<d.length&&r&&!q&&0!==d[a].s;a++)null!==d[a].args&&n.args.push.apply(n.args,d[a].args),d.splice(a,1),a--;0===d.length&&h("resolved")}this.args=[];this.promise=new l;var n=this,k=this.promise,d=[],q=!1,r=!1,t;a=0;for(t=b.length;a<t;a++){if(b[a]===m)throw Error("Undefined sent to push/add. Did you forget to return a deferred?");
d.push({d:b[a],s:0,args:null})}a=0;for(t=d.length;a<t&&!q;a++)if("function"===typeof d[a].d)d[a].s=1,this.promise.done(d[a].d);else{if("function"!==typeof d[a].d.then)throw Error("Invalid deferred sent to chain");(function(a){a.d.then(function(){if(0===a.s){a.args=g.call(arguments);a.s=1;var b=this;k.done(function(){p.set(b);for(var a=0;a<e.length;a++)b===e[a].d&&(k.done(e[a].func),e.splice(a,1),a--)});f()}},function(){if(0===a.s){n.args=g.call(arguments);a.s=1;var b=this;k.fail(function(){p.set(b);
for(var a=0;a<e.length;a++)b===e[a].d&&(k.fail(e[a].func),e.splice(a,1),a--)});h("rejected")}})})(d[a])}r=!0;f()}function l(a){this.ctx=a||this;this.s="pending";this.args=null;this.callbacks=[]}function u(){}function f(){function a(){for(var a=0;a<n.length;a++)n[a].call(p),n.splice(a,1),a--}function b(){var b=d!==m,c=new h(p,!b||d.completed);c.addFailCallback(a);b&&(d.nextLevel=c,c.prevLevel=d,d.removeFailCallback(a));d=c;return p.currentLevel=c}function c(a,c){if(d!==m&&"rejected"===d.state)return new u;
b();return d[a](c,f,s)}function e(a,c){if(d===m)b();else if("rejected"===d.state)return new u;return d[a](c,f,s)}var p=this,f=[],s=new v,n=[],k,d,q;this.push=this.next=function(){return c("requireDeferreds",g.call(arguments))};this.add=function(){return e("requireDeferreds",g.call(arguments))};this.pushIgnoreFail=this.nextIgnoreFail=function(){return c("optionalDeferreds",g.call(arguments))};this.addIgnoreFail=function(){return e("optionalDeferreds",g.call(arguments))};this.fail=this["catch"]=function(a){d===
m?n.push(a):d.addFailCallback(a);return this};var r=function(a,b,c){return function(){var d;d=c===m?function(){a.apply(b,g.call(arguments))}:function(){a.apply(b,c.concat(g.call(arguments)));c.length=0};this===p||this instanceof l||s.has(this)?d.apply(this,g.call(arguments)):f.push({d:this,func:d,s:this.state()})}};this.bind=function(a,b){return 3>arguments.length?r(a,b):r(a,b,g.call(arguments,2))};this.applyArgs=function(a,b){if(3>arguments.length)return k===m&&(k=[]),r(a,b,k);var c=g.call(arguments,
2);return function(){var d=(k||[]).splice(0,k.length).concat(c).concat(g.call(arguments));r(a,b,d).call(this)}};this.storeArgs=function(){var a=g.call(arguments),b=function(){k===m&&(k=[]);k.push.apply(k,a)};if(this===p)return b;this instanceof l||s.has(this)?b():f.push({d:this,func:b,s:this.state()})};this.state=function(){return d===m?"pending":("ignored"===d.state?"rejected":d.state)||"pending"};this.promise=function(){if(q===m){var a=function(a,b){return function(c,d,e){return a.call(b,c,d,e)}};
q={state:this.state,done:a(this.done,this),fail:a(this.fail,this),always:a(this.always,this),then:a(this.then,this)}}return q}}var v=x.WeakMap,g=[].slice,z=function(){return this},m;v===m&&(v=function(){var a=[];this.has=function(b){var c=-1;for(null!=b&&(c=a.length-1);0<=c&&a[c]!==b;)c--;return-1<c};this.set=function(b){a.push(b)}});h.prototype.newGroup=function(a,b,c,e){""===this.state&&(this.completed=!1);var f={s:0,r:this.ready};this.dfds.push(f);return new y(this.chain,a,function(a,c){f.g=c;
f.s=1;b(a)},c,e)};h.prototype.requireDeferreds=function(a,b,c){var e=this;return this.newGroup(a,function(a){switch(a){case "resolved":""===e.state&&(e.state="resolved");break;case "rejected":e.state="rejected"}e.complete()},b,c).promise};h.prototype.optionalDeferreds=function(a,b,c){var e=this;return this.newGroup(a,function(a){switch(a){case "resolved":""===e.state&&(e.state="resolved");break;case "rejected":e.state="ignored"}e.complete()},b,c).promise};h.prototype.addFailCallback=function(a){"ignored"===
this.state||"rejected"===this.state?a.call(this.chain):this.completed&&""!==this.state||this.failCallbacks.push(a)};h.prototype.removeFailCallback=function(a){a=this.failCallbacks.indexOf(a);-1!==a&&this.failCallbacks.splice(a,1)};h.prototype.complete=function(){if(!0===this.ready){for(var a=0;a<this.dfds.length;a++){if("function"===typeof this.dfds[a])this.dfds[a]();else{this.dfds[a].r=!0;if(0===this.dfds[a].s)break;this.dfds[a].g.complete(this.state)}this.dfds.splice(a,1);a--}0===this.dfds.length&&
(this.completed=!0);!0===this.completed&&("rejected"===this.state?this.failed():(this.cleanup(),null!==this.nextLevel&&(this.nextLevel.ready=!0,this.nextLevel.complete(),this.cleanupLevelRefs())))}};h.prototype.failed=function(){for(var a=0;a<this.failCallbacks.length;a++)this.failCallbacks[a].call(this.chain),this.failCallbacks.splice(a,1),a--;this.cleanup();null!==this.nextLevel&&(this.nextLevel.failed(),this.cleanupLevelRefs())};h.prototype.cleanup=function(a){var b,c;for(b=0;b<this.dfds.length;b++)this.dfds[b].r=
!1,this.dfds.splice(b,1),b--;b=0;for(c=this.failCallbacks.length;b<c;b++)this.failCallbacks.shift();null!==this.nextLevel&&a&&(this.nextLevel.cleanup(a),this.cleanupLevelRefs())};h.prototype.cleanupLevelRefs=function(){this.prevLevel=this.nextLevel=null};h.prototype.stop=function(a){this.ready=!1;this.state="rejected";this.cleanup(!0)};y.prototype.complete=function(a){var b=this.promise.callbacks;"pending"===this.promise.s&&(this.promise.s="ignored"===a?"rejected":a,this.promise.args=this.args);for(a=
0;a<b.length;a++)b[a].s===this.promise.s&&b[a].f.apply(this.promise.ctx,this.promise.args),b.splice(a,1),a--};l.prototype.done=function(){var a,b;if("resolved"===this.s)for(a=0,b=arguments.length;a<b;a++)arguments[a].apply(this.ctx,this.args);else if("pending"===this.s)for(a=0,b=arguments.length;a<b;a++){if("function"!==typeof arguments[a])throw Error("Invalid function sent to done "+typeof arguments[a]);this.callbacks.push({s:"resolved",f:arguments[a]})}return this};l.prototype.then=function(a,b){"function"===
typeof a?this.done(a):null!=a&&this.done.apply(this,a);"function"===typeof b?this.fail(b):null!=b&&this.fail.apply(this,b);return this};l.prototype.fail=function(){var a,b;if("rejected"===this.s)for(a=0,b=arguments.length;a<b;a++)arguments[a].apply(this.ctx,this.args);else if("pending"===this.s)for(a=0,b=arguments.length;a<b;a++){if("function"!==typeof arguments[a])throw Error("Invalid function sent to fail "+typeof arguments[a]);this.callbacks.push({s:"rejected",f:arguments[a]})}return this};l.prototype["catch"]=
l.prototype.fail;l.prototype.always=function(){var a=g.call(arguments);return this.fail.apply(this,a).done.apply(this,a)};l.prototype.state=function(){return this.s};for(var w in l.prototype)l.prototype.hasOwnProperty(w)&&"function"===typeof l.prototype[w]&&(u.prototype[w]=z);u.prototype.state=function(){return"pending"};f.prototype.done=f.prototype.after=function(a,b){b?this.add(a):this.push(a);return this};f.prototype.then=function(a,b){var c,e;if("function"===typeof a)this.done(a);else if(null!=
a)for(c=0,e=a.length;c<e;c++)this.done(a[c]);if("function"===typeof b)this.fail(b);else if(null!=b)for(c=0,e=b.length;c<e;c++)this.fail(b[c]);return this};f.prototype.always=function(a){if(1===arguments.length)return this.fail(a).done(a);var b=g.call(arguments);return this.fail.apply(this,b).done.apply(this,b)};f.prototype.fork=function(){var a=new f;a.push(this);return a};"undefined"!==typeof module?module.exports=f:(x.ChainLoading=f,"function"===typeof define&&"object"===typeof define.amd&&define.amd&&
define("ChainLoading",function(){return f}))})(this);
