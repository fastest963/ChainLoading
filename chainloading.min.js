(function(x){function l(a,b){this.chain=a;this.ready=b||!1;this.completed=!0;this.state="";this.dfds=[];this.failCallbacks=[];this.prevLevel=this.nextLevel=null}function y(a,b,c,e){function l(a){f||(f=!0,d.length=0,b(a,q))}function r(){for(var a=0;a<d.length&&h&&!f&&0!==d[a].s;a++)null!==d[a].args&&q.args.push.apply(q.args,d[a].args),d.splice(a,1),a--;0===d.length&&l("resolved")}this.args=[];this.promise=new n;var q=this,p=this.promise,d=[],f=!1,h=!1,k,t;k=0;for(t=a.length;k<t;k++){if(a[k]===g)throw Error("Undefined sent to push/add. Did you forget to return a deferred?");
d.push({d:a[k],s:0,args:null})}k=0;for(t=d.length;k<t&&!f;k++)if("function"===typeof d[k].d)d[k].s=1,this.promise.done(d[k].d);else{if("function"!==typeof d[k].d.then)throw Error("Invalid deferred sent to chain");(function(a){a.d.then(function(){if(0===a.s){a.args=m.call(arguments);a.s=1;var b=this;p.done(function(){e.set(b);for(var a=0;a<c.length;a++)b===c[a].d&&(p.done(c[a].func),c.splice(a,1),a--)});r()}},function(){if(0===a.s){q.args=m.call(arguments);a.s=1;var b=this;p.fail(function(){e.set(b);
for(var a=0;a<c.length;a++)b===c[a].d&&(p.fail(c[a].func),c.splice(a,1),a--)});l("rejected")}})})(d[k])}h=!0;r()}function n(a){this.ctx=a||this;this.s="pending";this.args=null;this.callbacks=[]}function u(){}function h(){function a(){if(p!==g)for(var a=0;a<p.length;a++)p[a].call(h),p.splice(a,1),a--}function b(){var b=f!==g,c=new l(h,!b||f.completed);p!==g&&c.addFailCallback(a);b&&(f.nextLevel=c,c.prevLevel=f,f.removeFailCallback(a));return f=c}function c(a,c){if(f!==g&&"rejected"===f.normalizedState())return new u;
b();return f[a](c,r,q)}function e(a,c){if(f===g)b();else if("rejected"===f.normalizedState())return new u;return f[a](c,r,q)}var h=this,r=[],q=new v,p,d,f,s;this.push=this.next=function(){return c("requireDeferreds",m.call(arguments))};this.add=function(){return e("requireDeferreds",m.call(arguments))};this.pushIgnoreFail=this.nextIgnoreFail=function(){return c("optionalDeferreds",m.call(arguments))};this.addIgnoreFail=function(){return e("optionalDeferreds",m.call(arguments))};this.stop=function(){var a=
f;if(a===g)a=b();else for(;null!==a.prevLevel&&(a=a.prevLevel););a.stop();return this};this.fail=this["catch"]=function(a){f===g?(p===g&&(p=[]),p.push(a)):f.addFailCallback(a);return this};var k=function(a,b,c){return function(){var d;d=c===g?function(){a.apply(b,m.call(arguments))}:function(){a.apply(b,c.concat(m.call(arguments)));c.length=0};this===h||this instanceof n||q.has(this)?d.apply(this,m.call(arguments)):r.push({d:this,func:d,s:this.state()})}};this.bind=function(a,b){return 3>arguments.length?
k(a,b):k(a,b,m.call(arguments,2))};this.applyArgs=function(a,b){if(3>arguments.length)return d===g&&(d=[]),k(a,b,d);var c=m.call(arguments,2);return function(){var e=(d||[]).splice(0,d.length).concat(c).concat(m.call(arguments));k(a,b,e).call(this)}};this.storeArgs=function(){var a=m.call(arguments),b=function(){d===g&&(d=[]);d.push.apply(d,a)};if(this===h)return b;this instanceof n||q.has(this)?b():r.push({d:this,func:b,s:this.state()})};this.state=function(){return f===g?"pending":f.normalizedState()};
this.promise=function(){if(s===g){var a=function(a,b){return function(c,d,e){return a.call(b,c,d,e)}};s={state:this.state,done:a(this.done,this),fail:a(this.fail,this),always:a(this.always,this),then:a(this.then,this)}}return s}}var v=x.WeakMap,m=[].slice,s=[].indexOf,z=function(){return this},g;v===g&&(v=function(){var a=[];this.has=function(b){var c=-1;for(null!=b&&(c=a.length-1);0<=c&&a[c]!==b;)c--;return-1<c};this.set=function(b){a.push(b)}});s===g&&(s=function(a,b){var c=this.length,e=+b||0;
if(0===c||e>=c)return-1;isFinite(e)||(e=0);for(0>e&&(e=Math.max(c-Math.abs(e),0));e<c;){if(this[e]===a)return e;e++}return-1});l.prototype.newGroup=function(a,b,c,e){""===this.state&&(this.completed=!1);var h={s:0,r:this.ready},g=this;this.dfds.push(h);return new y(a,function(a,c){h.g=c;h.s=1;switch(a){case "resolved":""===g.state&&(g.state="resolved");break;case "rejected":"stopped"!==g.state&&(g.state=b)}g.complete()},c,e)};l.prototype.requireDeferreds=function(a,b,c){return this.newGroup(a,"rejected",
b,c).promise};l.prototype.optionalDeferreds=function(a,b,c){return this.newGroup(a,"ignored",b,c).promise};l.prototype.addFailCallback=function(a){"ignored"===this.state||"rejected"===this.state?a.call(this.chain):this.completed&&""!==this.state||this.failCallbacks.push(a)};l.prototype.removeFailCallback=function(a){a=s.call(this.failCallbacks,a);-1!==a&&this.failCallbacks.splice(a,1)};l.prototype.complete=function(){if(!0===this.ready){var a="ignored"===this.state?"rejected":this.normalizedState(),
b;for(b=0;b<this.dfds.length;b++){if("function"===typeof this.dfds[b])this.dfds[b]();else{this.dfds[b].r=!0;if(0===this.dfds[b].s)break;this.dfds[b].g.complete(a)}this.dfds.splice(b,1);b--}0===this.dfds.length&&("rejected"===this.state?this.completeFailed():(this.cleanup(),"stopped"!==this.state&&(null!==this.nextLevel&&(this.nextLevel.ready=!0,this.nextLevel.complete()),this.cleanupLevelRefs())))}};l.prototype.completeFailed=function(){for(var a=0;a<this.failCallbacks.length;a++)this.failCallbacks[a].call(this.chain),
this.failCallbacks.splice(a,1),a--;this.cleanup();null!==this.nextLevel&&this.nextLevel.completeFailed();this.cleanupLevelRefs()};l.prototype.cleanup=function(a){var b;for(a=0;a<this.dfds.length;a++)this.dfds[a].r=!1,this.dfds.splice(a,1),a--;this.completed=!0;a=0;for(b=this.failCallbacks.length;a<b;a++)this.failCallbacks.shift()};l.prototype.cleanupLevelRefs=function(){this.prevLevel=this.nextLevel=null};l.prototype.normalizedState=function(){return"stopped"===this.state?"rejected":"ignored"===this.state?
"resolved":this.state||"pending"};l.prototype.stop=function(a){this.ready=!1;this.state="stopped";this.cleanup();null!==this.nextLevel&&this.nextLevel.stop();this.cleanupLevelRefs()};y.prototype.complete=function(a){var b=this.promise.callbacks;"pending"===this.promise.s&&(this.promise.s=a,this.promise.args=this.args);for(a=0;a<b.length;a++)b[a].s===this.promise.s&&b[a].f.apply(this.promise.ctx,this.promise.args),b.splice(a,1),a--};n.prototype.done=function(){var a,b;if("resolved"===this.s)for(a=
0,b=arguments.length;a<b;a++)arguments[a].apply(this.ctx,this.args);else if("pending"===this.s)for(a=0,b=arguments.length;a<b;a++){if("function"!==typeof arguments[a])throw Error("Invalid function sent to done "+typeof arguments[a]);this.callbacks.push({s:"resolved",f:arguments[a]})}return this};n.prototype.then=function(a,b){"function"===typeof a?this.done(a):null!=a&&this.done.apply(this,a);"function"===typeof b?this.fail(b):null!=b&&this.fail.apply(this,b);return this};n.prototype.fail=function(){var a,
b;if("rejected"===this.s)for(a=0,b=arguments.length;a<b;a++)arguments[a].apply(this.ctx,this.args);else if("pending"===this.s)for(a=0,b=arguments.length;a<b;a++){if("function"!==typeof arguments[a])throw Error("Invalid function sent to fail "+typeof arguments[a]);this.callbacks.push({s:"rejected",f:arguments[a]})}return this};n.prototype["catch"]=n.prototype.fail;n.prototype.always=function(){var a=m.call(arguments);return this.fail.apply(this,a).done.apply(this,a)};n.prototype.state=function(){return this.s};
for(var w in n.prototype)n.prototype.hasOwnProperty(w)&&"function"===typeof n.prototype[w]&&(u.prototype[w]=z);u.prototype.state=function(){return"pending"};h.prototype.done=h.prototype.after=function(a,b){b?this.add(a):this.push(a);return this};h.prototype.then=function(a,b){var c,e;if("function"===typeof a)this.done(a);else if(null!=a)for(c=0,e=a.length;c<e;c++)this.done(a[c]);if("function"===typeof b)this.fail(b);else if(null!=b)for(c=0,e=b.length;c<e;c++)this.fail(b[c]);return this};h.prototype.always=
function(a){if(1===arguments.length)return this.fail(a).done(a);var b=m.call(arguments);return this.fail.apply(this,b).done.apply(this,b)};h.prototype.fork=function(){var a=new h;a.push(this);return a};"undefined"!==typeof module?module.exports=h:(x.ChainLoading=h,"function"===typeof define&&"object"===typeof define.amd&&define.amd&&define("ChainLoading",function(){return h}))})(this);
